<!--app/forum/templates/forum/post_detail.html-->

{% extends 'base.html' %}
{% block title %}{{ post.title }} - Sophia Agora{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reaction.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_comment.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h2>{{ post.title }}</h2>
    <p class="meta">
        ç”± <span class="author">{{ post.user.display_name }}</span> ç™¼è¡¨æ–¼
        <span>{{ post.created_at|utc_span }}</span>
    </p>

    <div class="post-content">{{ post.content|safe }}</div>

    <!-- ğŸ†• Post Reaction + Edit Buttons -->
    <div class="post-reaction-bar d-flex justify-content-between align-items-center mt-3" data-post-id="{{ post.id }}">
        <div class="reaction-buttons" data-post-id="{{ post.id }}">
            <button class="reaction-btn like me-2" data-type="like">
                ğŸ‘ <span class="like-count">{{ post.like_count }}</span>
            </button>
            <button class="reaction-btn dislike" data-type="dislike">
                ğŸ‘ <span class="dislike-count">{{ post.dislike_count }}</span>
            </button>
        </div>
        <div class="edit-buttons d-flex gap-2">
            {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_admin) %}
                <a href="{{ url_for('post.edit_post_form', post_id=post.id) }}" class="btn btn-outline-primary btn-sm">
                    âœï¸ ç·¨è¼¯
                </a>
                <form method="POST" action="{{ url_for('post.delete_post', post_id=post.id) }}" class="d-inline"
                    onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡ç« å—ï¼Ÿé€™å°‡ä¸€ä½µåˆªé™¤æ‰€æœ‰ç•™è¨€èˆ‡æ­·å²ç´€éŒ„ï¼');">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        ğŸ—‘ï¸ åˆªé™¤
                    </button>
                </form>
                <button class="btn btn-outline-secondary btn-sm view-post-history-btn" data-post-id="{{ post.id }}">
                    ğŸ•˜ æ­·å²ç´€éŒ„
                </button>
            {% endif %}
            {% if current_user.is_authenticated and current_user.id != post.user_id %}
                <button class="btn btn-outline-danger btn-sm"
                        onclick="openReportModal('{{ post.user.id }}', 'post', '{{ post.id }}')">
                    ğŸš¨ æª¢èˆ‰
                </button>
            {% endif %}
        </div>
    </div>

    <hr>
    <h3>ç•™è¨€</h3>
    {% if current_user.is_authenticated %}
        <form action="{{ url_for('comment.add_comment') }}" method="post">
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <textarea name="content" rows="3" placeholder="ç•™ä¸‹ä½ çš„å›æ‡‰..." required></textarea>
            <button type="submit">ç•™è¨€</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('auth.login') }}">ç™»å…¥</a>å¾Œæ‰èƒ½ç•™è¨€ã€‚</p>
    {% endif %}

    <hr>
    <h3>ç•™è¨€å€</h3>
    <div class="comments">
        {% for comment in post.comments %}
            <div class="comment">
                <p><strong>{{ comment.user.display_name }}</strong>ï¼š{{ comment.content }}</p>
                <div class="reaction-buttons" data-comment-id="{{ comment.id }}">
                    <button class="reaction-btn like" data-type="like">ğŸ‘ <span class="like-count">{{ comment.like_count }}</span></button>
                    <button class="reaction-btn dislike" data-type="dislike">ğŸ‘ <span class="dislike-count">{{ comment.dislike_count }}</span></button>
                </div>
                <p class="meta">
                    <span>{{ comment.created_at|utc_span }}</span>
                    {% if current_user.is_authenticated %}
                        {% if current_user.id == comment.user_id or current_user.is_admin %}
                            <button class="btn btn-sm btn-outline-secondary me-2 edit-comment-btn"
                                    data-comment-id="{{ comment.id }}"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editCommentModal">
                                âœï¸ ç·¨è¼¯
                            </button>
                            <form method="POST" action="{{ url_for('comment.delete_comment', comment_id=comment.id) }}" class="inline-form d-inline">
                                <button type="submit" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ')" class="btn btn-sm btn-outline-danger">ğŸ—‘ï¸ åˆªé™¤</button>
                            </form>
                            <button class="btn btn-sm btn-outline-info view-comment-history-btn"
                                    data-comment-id="{{ comment.id }}">
                                ğŸ•“ æ­·å²
                            </button>
                        {% endif %}
                        {% if current_user.id != comment.user_id %}
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="openReportModal('{{ comment.user.id }}', 'comment', '{{ comment.id }}')">
                                ğŸš¨ æª¢èˆ‰
                            </button>
                        {% endif %}
                    {% endif %}
                </p>
            </div>
        {% else %}
            <p>ç›®å‰å°šç„¡ç•™è¨€ï¼Œæ­¡è¿ç•™è¨€ç™¼è¡¨çœ‹æ³•ï¼</p>
        {% endfor %}
    </div>
</div>

<!-- ç·¨è¼¯ç•™è¨€ Modal -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editCommentForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editCommentModalLabel">ç·¨è¼¯ç•™è¨€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="comment_id" id="edit-comment-id">
          <textarea name="content" id="edit-comment-content" class="form-control" rows="4" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">æ›´æ–°ç•™è¨€</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- æª¢èˆ‰ Modal -->
{% include 'report/report_modal.html' %}

<!-- Toast æç¤º -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="reportToast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        âœ… æª¢èˆ‰æˆåŠŸï¼æ„Ÿè¬ä½ çš„å›å ±ï¼Œæˆ‘å€‘æœƒå„˜é€Ÿå¯©æŸ¥ã€‚
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- å‹•æ…‹å…§å®¹ -->
<div id="dynamic-modal-container"></div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/edit_comment.js') }}"></script>
    <script src="{{ url_for('static', filename='js/edit_history.js') }}"></script>
    <script src="{{ url_for('static', filename='js/report_modal.js') }}"></script>
{% endblock %}